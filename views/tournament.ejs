<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Welcome to Slingshot</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js" integrity="sha384-1CmrxMRARb6aLqgBO7yyAxTOQE2AKb9GfXnEo760AUcUmFx3ibVJJAzGytlQcNXd" crossorigin="anonymous"></script>
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/glide.core.css">
  <link rel="stylesheet" href="/css/glide.theme.min.css">
  <link rel="stylesheet" href="/css/tournament.css">
</head>
<script>
  $(document).ready(function() {
    
    $('[data-toggle=offcanvas]').click(function() {
      $('.row-offcanvas').toggleClass('active');
    });
    
  });
</script>
<body>
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary mb-3">
    <div class="flex-row d-flex">
        <button type="button" class="navbar-toggler mr-2 " data-toggle="offcanvas" title="Toggle responsive left sidebar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand justify-content-center" href="/" title="Free Bootstrap 4 Admin Template">Slingshot</a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsingNavbar">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="navbar-collapse collapse" id="collapsingNavbar">
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="/"><i class = "fa fa-home"></i> Home <span class="sr-only">Home</span></a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="/gettournament"><i class = "fa fa-gamepad"></i> Host</a>
            </li>
        </ul>
        <% if(user){ %>
          <ul class="nav navbar-nav ml-auto">
              <li class="nav-item active">
                <a class="nav-link" href="/"><i class = "fa fa-user-circle"></i> <%= user.name %></a>
              </li>
            </ul>
        <% }else{ %>
              <ul class="nav navbar-nav ml-auto">
                  <li class="nav-item active">
                    <a class="nav-link" href="/signup"><i class = "fa fa-user"></i> Signup</a>
                  </li>
                  <li class="nav-item active">
                      <a class="nav-link" href="/login">Login</a>
                  </li>
                </ul>
            <% } %>
    </div>
</nav>
<div class="container-fluid" id="main">
  <div class="row row-offcanvas row-offcanvas-left" id = "fixl">
      <div class="col-md-3 col-lg-2 sidebar-offcanvas pl-0" id="sidebar" role="navigation">
          <ul class="nav flex-column pl-0 pt-5 mt-3 mr-0">
              <h3 class = "text-center h3 mb-4" id = "gameHead">Games</h3>
              <% _.forEach(games, (game) => { %>
                <li class="nav-item"><a class="nav-link" id = "gameLink" href="/tournaments/<%= game.name %>">
                    <div class = "row mb-0" id = "gameList">
                      <div style = "color: #151515">ff</div>
                      <div class = "col-10" style = "margin-left: -5px;"><%= game.name %></div>
                      <div>
                          <span class = "badge badge-primary"><%= game.tournaments.length %></span>
                      </div>
                    </div>
                  </a></li>
              <% }) %>
          </ul>
      </div>
      <div class="col main pt-5 mt-3">
          <div class = "jumbotron pt-0">
              <% if(isPre){ %> 
                <div class = "alert alert-primary text-center mb-1">
                  <a href = "#" class = "close" data-dismiss = "alert" aria-label="close">&times;</a>
                      <% _.forEach(messages, (error) => { %>
                        <%= error %>
                      <% }) %>
                </div>
              <% } %>
              <h3 class = "h3 mb-4" id = "gameHead"><%= tournament.name %></h3>
              <div class="row pb-2">
                    <div class="col-md-6 mb-3"><img src="/img/<%= tournament.game.cover %>" class="float-right img-fluid img-rounded"></div>
                    <div class="col-md-6">
                        <h4 class = "h4 mb-4 text-center" style = "color: #fff">Details</h4>
                        <!-- <p style="white-space: pre-line;white-space: pre-wrap;color: #d3d3d3"><%= tournament.desc %></p> -->
                        <div class = "row">
                                <div class="col"><p class="card-text mb-2" id = "con"><i class="fa fa-calendar-o mb-3" id = "ticon"></i> &nbsp; <%= moment(tournament.starts).tz('Asia/Calcutta').format('ll'); %> <span class = "badge badge-primary badge-pill"><%= moment(tournament.starts, "YYYYMMDD").fromNow(); %></span></p></div>
                        </div>
                        <div class="row mb-3">
                                <div class="col-7"><p class="card-text mb-1" id = "con"><i class="fa fa-clock-o" id = "ticon"></i> &nbsp; <%= moment(tournament.starts).tz('Asia/Calcutta').format('LT z'); %></p></div>
                                <div class="col-5"><p class="card-text" id = "con"><i class="fa fa-trophy" id = "ticon"></i> &nbsp;  ₹‎1000 </p></div>
                                <div class="w-100"></div>
                                <div class="col-7"><p class="card-text" id = "con"><i class="fa fa-money" id = "ticon"></i> &nbsp;  ₹‎<%= tournament.price %>/kill</p></div>
                                <div class="col-5"><p class="card-text" id = "con"><i class="fa fa-users" id = "ticon"></i> &nbsp;  <%= tournament.players.length %>/<%= tournament.participants %></p></div>
                            </div>
                        <button class = "btn btn-primary btn-block" data-toggle="modal" data-target="#myModal">Join</button>
                        <div class = "row py-2">
                            <p style = "color: #fff;font-weight: bolder; font-size: 20px;"><span class = "badge badge-success badge-pill ml-3" style = "font-size: 30px;letter-spacing: 2px;">₹<%= tournament.price %></span>/entry</p>
                          </div>
                    </div>
              <section class="container py-4">
                    <div class="row">
                        <div class="col-md-12">
                            <ul id="tabsJustified" class="nav nav-tabs nav-fill">
                                <li class="nav-item"><a href="" data-target="#home1" data-toggle="tab" class="nav-link small text-uppercase">Home</a></li>
                                <li class="nav-item"><a href="" data-target="#profile1" data-toggle="tab" class="nav-link small text-uppercase active">Profile</a></li>
                                <li class="nav-item"><a href="" data-target="#messages1" data-toggle="tab" class="nav-link small text-uppercase">Messages</a></li>
                            </ul>
                            <br>
                            <div id="tabsJustifiedContent" class="tab-content">
                                <div id="home1" class="tab-pane fade">
                                    <div class="list-group"><a href="" class="list-group-item d-inline-block"><span class="float-right badge badge-pill badge-dark">51</span> Home Link</a> <a href="" class="list-group-item d-inline-block"><span class="float-right badge badge-pill badge-dark">8</span> Link 2</a> <a href="" class="list-group-item d-inline-block"><span class="float-right badge badge-pill badge-dark">23</span> Link 3</a> <a href="" class="list-group-item d-inline-block text-muted">Link n..</a></div>
                                </div>
                                <div id="profile1" class="tab-pane fade active show">
                                    <div class="row pb-2">
                                        <div class = "col-md-12">
                                            <input type=text id=order-id >
                                            <br/>
                                            <input type=text id=order-pay-id>
                                            <br/>
                                            <input type=text id=order-sig>
                                            <br/>
                                            <button id="verify-button1"></button>
                                        </div>
                                    </div>
                                </div>
                                <div id="messages1" class="tab-pane fade">
                                    <table class="table table-dark">
                                    <thead>
                                        <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">First</th>
                                        <th scope="col">Last</th>
                                        <th scope="col">Handle</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                          <% _.forEach(players, (player) => { %>
                                            <tr>
                                                <th scope="row">1</th>
                                                <td><%= player.user.name %></td>
                                                <td><%= player.username %></td>
                                                <td>@mdo</td>
                                            </tr>
                                          <% }) %>  
                                        </tbody>
                                    </table>   
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                              <div class="modal-content" style = "background: #151515">
                                <div class="modal-header py-1" style = "border: 0;">
                                <h4 class = "h3 mt-3" style = "color: #d3d3d3;"><i class = "fa fa-sign-in"></i> Enter Username%></h4><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                                </div>
                                <div class="modal-body py-2" style = "border: 0;">
                                  <!-- <p><a title="Facebook" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-facebook fa-stack-1x"></i></span></a> <a title="Twitter" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x"></i></span></a> <a title="Google+" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-google-plus fa-stack-1x"></i></span></a> <a title="Linkedin" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x"></i></span></a> <a title="Reddit" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-reddit fa-stack-1x"></i></span></a> <a title="WordPress" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-wordpress fa-stack-1x"></i></span></a> <a title="Digg" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-digg fa-stack-1x"></i></span></a>  <a title="Stumbleupon" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-stumbleupon fa-stack-1x"></i></span></a><a title="E-mail" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x"></i></span></a>  <a title="Print" href=""><span class="fa-stack fa-lg"><i class="fa fa-square-o fa-stack-2x"></i><i class="fa fa-print fa-stack-1x"></i></span></a></p> -->
                                            <p><%= tournament.price %></p>
                                              <div class="input-group">
                                                <input type="text" name = "username" id = "username" class="form-control" placeholder="<%= tournament.game.name %> username">
                                              </div>
                                              <div class="input-group mt-3 mb-2">
                                                    <button id = "order-button1" class = "btn btn-primary btn-block" data-dismiss = "modal">Proceed to pay</button>
                                              </div>
                                </div>
                              </div>
                            </div>
                          </div>
                </section>
          </div>
      </div>

      <script>
          document.getElementById('order-button1').onclick = function(e){
              var url = '/api/payment/order/<%= tournament._id %>';

                  var params = {
                    redeipt: 'B1010'
                  };

                  var xmlHttp = new XMLHttpRequest();
                  xmlHttp.onreadystatechange = function (res) {
                      if (xmlHttp.readyState === 4) {
                        res=JSON.parse(xmlHttp.responseText);
                        var options = {
                            "key": "rzp_test_O1PrDYl7c0Fbi2",  //Enter your razorpay key
                            "currency": "INR",
                            "name": "SlingShot",
                            "description": "Your Gaming Partner",
                            "image": "/img/clashCover.jpg",
                            "order_id": res.sub.id,
                            "handler": function (response){
                                document.getElementById('order-pay-id').value= response.razorpay_payment_id;
                                document.getElementById('order-id').value= response.razorpay_order_id;
                                document.getElementById('order-sig').value= response.razorpay_signature;
                                document.getElementById("verify-button1").click(); 
                            },
                            "theme": {
                                "color": "#101010"
                            }
                        };
                            var rzp1 = new Razorpay(options);
                            rzp1.open();
                      }
                  }
                  xmlHttp.open("POST", url, true); // false for synchronous request
                  xmlHttp.setRequestHeader("Content-type", "application/json");
                  xmlHttp.send(JSON.stringify(params));
                }



                $( "#verify-button1" ).click(function() {
                var url = '/api/payment/verify';
                    var params = {
                        razorpay_order_id:  document.getElementById('order-id').value,  
                        razorpay_payment_id:  document.getElementById('order-pay-id').value,
                        razorpay_signature:  document.getElementById('order-sig').value
                      };
                  var xmlHttp = new XMLHttpRequest();
                      xmlHttp.onreadystatechange = function (res) {
                          if (xmlHttp.readyState === 4) {
                              alert(xmlHttp.responseText);
                          }
                      }
                xmlHttp.open("POST", url, true); // false for synchronous request
                xmlHttp.setRequestHeader("Content-type", "application/json");
                xmlHttp.send(JSON.stringify(params));
                });
          </script>
</body>
</html>